name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  validate-skill:
    name: Validate Skill File
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check skill file exists
        run: |
          if [ ! -f "unit-testing.skill" ]; then
            echo "‚ùå unit-testing.skill file not found!"
            exit 1
          fi
          echo "‚úÖ Skill file found"

      - name: Validate skill structure
        run: |
          # Check if it's a valid ZIP file
          if ! unzip -t unit-testing.skill > /dev/null 2>&1; then
            echo "‚ùå Skill file is not a valid ZIP archive!"
            exit 1
          fi
          echo "‚úÖ Skill file is a valid ZIP"

      - name: Extract and validate content
        run: |
          mkdir -p /tmp/skill-test
          unzip -q unit-testing.skill -d /tmp/skill-test

          # Check for required files
          if [ ! -f "/tmp/skill-test/unit-testing/SKILL.md" ]; then
            echo "‚ùå SKILL.md not found in skill package!"
            exit 1
          fi

          echo "‚úÖ SKILL.md found"

          # Validate SKILL.md has frontmatter
          if ! head -1 /tmp/skill-test/unit-testing/SKILL.md | grep -q "^---$"; then
            echo "‚ùå SKILL.md missing YAML frontmatter!"
            exit 1
          fi

          echo "‚úÖ SKILL.md has valid frontmatter"

  test-python-examples:
    name: Test Python Examples
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.11', '3.12']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          if [ -f "examples/python/requirements.txt" ]; then
            python -m pip install --upgrade pip
            pip install -r examples/python/requirements.txt
            echo "‚úÖ Python dependencies installed"
          else
            echo "‚ö†Ô∏è No requirements.txt found, skipping tests"
            exit 0
          fi

      - name: Run Python tests
        continue-on-error: true
        run: |
          if [ -d "examples/python" ] && [ -n "$(find examples/python -name 'test_*.py' -o -name '*_test.py')" ]; then
            cd examples/python
            pytest -v --tb=short || echo "‚ö†Ô∏è Some tests failed (educational examples)"
            echo "‚úÖ Python tests executed"
          else
            echo "‚ö†Ô∏è No Python tests found, skipping"
          fi

  test-javascript-examples:
    name: Test JavaScript Examples
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: ['20', '22']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - name: Install dependencies
        run: |
          if [ -f "examples/javascript/package.json" ]; then
            cd examples/javascript
            npm install
            echo "‚úÖ JavaScript dependencies installed"
          else
            echo "‚ö†Ô∏è No package.json found, skipping tests"
            exit 0
          fi

      - name: Run JavaScript tests
        continue-on-error: true
        run: |
          if [ -f "examples/javascript/package.json" ]; then
            cd examples/javascript
            npm test || echo "‚ö†Ô∏è Some tests failed (educational examples)"
            echo "‚úÖ JavaScript tests executed"
          else
            echo "‚ö†Ô∏è No JavaScript tests found, skipping"
          fi

  lint-markdown:
    name: Lint Markdown
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install markdownlint
        run: npm install -g markdownlint-cli

      - name: Lint markdown files
        run: |
          markdownlint '**/*.md' --ignore node_modules --ignore .github || true
          echo "‚úÖ Markdown linting complete"

  check-links:
    name: Check Dead Links
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check links in README
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          config-file: '.github/markdown-link-check-config.json'
        continue-on-error: true

  build-status:
    name: Build Status
    runs-on: ubuntu-latest
    needs: [validate-skill, test-python-examples, test-javascript-examples, lint-markdown]
    if: always()

    steps:
      - name: Check build status
        run: |
          echo "üìä Build Status Summary:"
          echo "  Skill Validation: ${{ needs.validate-skill.result }}"
          echo "  Python Tests: ${{ needs.test-python-examples.result }}"
          echo "  JavaScript Tests: ${{ needs.test-javascript-examples.result }}"
          echo "  Markdown Lint: ${{ needs.lint-markdown.result }}"

          if [ "${{ needs.validate-skill.result }}" == "success" ]; then
            echo "‚úÖ Core validation passed - Skill is valid!"
            exit 0
          else
            echo "‚ùå Skill validation failed"
            exit 1
          fi
