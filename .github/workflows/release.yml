name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Version: $VERSION"

      - name: Validate skill file
        run: |
          if [ ! -f "unit-testing.skill" ]; then
            echo "âŒ Skill file not found!"
            exit 1
          fi

          unzip -t unit-testing.skill
          echo "âœ… Skill file validated"

      - name: Extract changelog for this version
        id: changelog
        run: |
          # Extract the section for this version from CHANGELOG.md
          VERSION="v${{ steps.version.outputs.version }}"

          if grep -q "## \[$VERSION\]" CHANGELOG.md; then
            sed -n "/## \[$VERSION\]/,/## \[/p" CHANGELOG.md | sed '$d' > release-notes.md
            echo "âœ… Changelog extracted for $VERSION"
          else
            echo "âš ï¸ No changelog entry found for $VERSION, using generic notes"
            echo "Release $VERSION" > release-notes.md
            echo "" >> release-notes.md
            echo "See [CHANGELOG.md](CHANGELOG.md) for details." >> release-notes.md
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: unit-testing.skill
          body_path: release-notes.md
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Announce release
        run: |
          echo "ğŸ‰ Release ${{ steps.version.outputs.version }} published!"
          echo "ğŸ“¦ Skill file attached to release"
          echo "ğŸ“ Release notes generated from CHANGELOG.md"

  notify-community:
    name: Notify Community
    runs-on: ubuntu-latest
    needs: create-release
    if: success()

    steps:
      - name: Create notification
        run: |
          echo "ğŸš€ New version released!"
          echo "Consider announcing on:"
          echo "  - GitHub Discussions"
          echo "  - Twitter/X"
          echo "  - Discord/Slack communities"
